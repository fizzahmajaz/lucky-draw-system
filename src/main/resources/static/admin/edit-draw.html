<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Edit Draw</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">

    <!-- Central CSS -->
    <link rel="stylesheet" href="/assets/css/style.css">

    <style>

        .content {
            margin: auto;
            padding: 30px;
        }

        label {
            font-weight: 600;
            font-size: 15px;
        }

        .form-control {
            font-size: 15px;
            padding: 10px;
            font-weight: 600;
        }

        .btn-apple {
            background: #111;
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 700;
            border: none;
            width: 100%;
            font-size: 16px;
        }

        .card-apple {
            background: white;
            padding: 20px;
            border-radius: 18px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.05);
        }
    </style>
</head>

<body>


    <!-- Toast container (if not already in layout) -->
    <div id="toast-box" class="toast-box"></div>

    <!-- Main Content -->
    <div class="content">
        <h2 class="mb-4">Edit Draw</h2>

        <div class="card-apple">

            <form onsubmit="saveDraw(event)">

                <!-- Draw Name -->
                <label>Draw Name</label>
                <input type="text" id="name" class="form-control mb-3">

                <!-- Prize (READ ONLY) -->
                <label>Prize (not editable)</label>
                <input type="text" id="prize" class="form-control mb-3" readonly>

                <!-- Voucher Access -->
                <label>Voucher Code (For visibility control)</label>
                <input type="text" id="accessVoucher" class="form-control mb-3" placeholder="MD612 / COMP12 / EID2024">

                <label>Access Level</label>
                <select id="voucherAccessLevel" class="form-control mb-3">
                    <option value="ALL">All Users</option>
                    <option value="RESTRICTED">Restricted (Voucher-based)</option>
                </select>

                <!-- Dates -->
                <label>Start Date</label>
                <input type="datetime-local" id="startDate" class="form-control mb-3">

                <label>End Date</label>
                <input type="datetime-local" id="endDate" class="form-control mb-3">

                <!-- Department -->
                <label>Department</label>
                <input type="text" id="department" class="form-control mb-3">

                <!-- Timer: Hours / Minutes / Seconds -->
                <label>Timer</label>
                <div class="row g-2 mb-3">
                    <div class="col-4 col-md-2">
                        <input type="number" id="timerHours" class="form-control" min="0" value="0">
                        <small class="text-muted">Hours</small>
                    </div>
                    <div class="col-4 col-md-2">
                        <input type="number" id="timerMinutes" class="form-control" min="0" max="59" value="0">
                        <small class="text-muted">Minutes</small>
                    </div>
                    <div class="col-4 col-md-2">
                        <input type="number" id="timerSeconds" class="form-control" min="0" max="59" value="0">
                        <small class="text-muted">Seconds</small>
                    </div>
                </div>

                <!-- Max Winners -->
                <label>Max Winners</label>
                <input type="number" id="maxWinners" class="form-control mb-4" placeholder="Example: 1, 2, 5">

                <!-- Description -->
                <label>Description</label>
                <textarea id="description" class="form-control mb-4" placeholder="Optional details"></textarea>

                <div class="d-flex gap-2">
                    <button class="btn-apple" type="submit">Save Changes</button>
                    <button class="btn btn-outline-secondary" type="button" onclick="goBack()">Cancel</button>
                </div>
            </form>

        </div>
    </div>

    <script src="/assets/js/common.js"></script>

    <script>
        var currentDrawId = null;

        // Convert backend date to input type="datetime-local"
        function formatForInput(value) {
            if (!value) return "";
            var d = new Date(value);
            if (isNaN(d.getTime())) {
                return value; // if backend already gives 2025-11-20T23:59:00
            }
            var year = d.getFullYear();
            var month = d.getMonth() + 1;
            var day = d.getDate();
            var hours = d.getHours();
            var minutes = d.getMinutes();

            if (month < 10) month = "0" + month;
            if (day < 10) day = "0" + day;
            if (hours < 10) hours = "0" + hours;
            if (minutes < 10) minutes = "0" + minutes;

            return year + "-" + month + "-" + day + "T" + hours + ":" + minutes;
        }

        function goBack() {
            redirectTo("/admin/view-draws.html");
        }

        window.onload = function () {
            var adminId = localStorage.getItem("adminId");
            if (!adminId) {
                redirectTo("/admin/login.html");
                return;
            }

            var params = new URLSearchParams(window.location.search);
            var idParam = params.get("id");
            if (!idParam) {
                showToast("No draw selected to edit", false);
                return;
            }

            currentDrawId = idParam;
            loadDraw();
        };

        function loadDraw() {
            apiFetch("/draws/" + currentDrawId, "GET")
                .then(function (json) {
                    if (!json || !json.success) {
                        showToast("Failed to load draw details", false);
                        return;
                    }

                    var d = json.data;

                    // Name
                    var nameEl = document.getElementById("name");
                    if (nameEl) nameEl.value = d.name ? d.name : "";

                    // Prize (read-only)
                    var prizeEl = document.getElementById("prize");
                    if (prizeEl) prizeEl.value = d.prize ? d.prize : "";

                    // Access voucher & level
                    var vCodeEl = document.getElementById("accessVoucher");
                    if (vCodeEl) vCodeEl.value = d.voucherCode ? d.voucherCode : "";

                    var vLevelEl = document.getElementById("voucherAccessLevel");
                    if (vLevelEl) vLevelEl.value = d.voucherAccessLevel ? d.voucherAccessLevel : "ALL";

                    // Dates
                    var startEl = document.getElementById("startDate");
                    if (startEl) startEl.value = formatForInput(d.startDate);

                    var endEl = document.getElementById("endDate");
                    if (endEl) endEl.value = formatForInput(d.endDate);

                    // Department
                    var depEl = document.getElementById("department");
                    if (depEl) depEl.value = d.department ? d.department : "";

                    // Timer -> split into H/M/S
                    var totalSeconds = d.timerSeconds !== undefined && d.timerSeconds !== null ? d.timerSeconds : 0;
                    var hours = Math.floor(totalSeconds / 3600);
                    var remainder = totalSeconds % 3600;
                    var minutes = Math.floor(remainder / 60);
                    var seconds = remainder % 60;

                    var hEl = document.getElementById("timerHours");
                    var mEl = document.getElementById("timerMinutes");
                    var sEl = document.getElementById("timerSeconds");

                    if (hEl) hEl.value = hours;
                    if (mEl) mEl.value = minutes;
                    if (sEl) sEl.value = seconds;

                    // Max Winners
                    var mwEl = document.getElementById("maxWinners");
                    if (mwEl) mwEl.value = (d.maxWinners !== undefined && d.maxWinners !== null) ? d.maxWinners : "";

                    // Description
                    var descEl = document.getElementById("description");
                    if (descEl) descEl.value = d.description ? d.description : "";
                });
        }

        function saveDraw(event) {
            event.preventDefault();

            var adminId = localStorage.getItem("adminId");
            if (!adminId) {
                redirectTo("/admin/login.html");
                return;
            }

            if (!currentDrawId) {
                showToast("No draw selected", false);
                return;
            }

            var h = parseInt(document.getElementById("timerHours").value, 10);
            var m = parseInt(document.getElementById("timerMinutes").value, 10);
            var s = parseInt(document.getElementById("timerSeconds").value, 10);

            if (isNaN(h) || h < 0) h = 0;
            if (isNaN(m) || m < 0) m = 0;
            if (isNaN(s) || s < 0) s = 0;
            if (m > 59) m = 59;
            if (s > 59) s = 59;

            var totalSeconds = (h * 3600) + (m * 60) + s;

            var name = document.getElementById("name").value.trim();
            var prize = document.getElementById("prize").value.trim(); // not editable but still sent
            var accessVoucher = document.getElementById("accessVoucher").value.trim();
            var voucherAccessLevel = document.getElementById("voucherAccessLevel").value;
            var startDate = document.getElementById("startDate").value;
            var endDate = document.getElementById("endDate").value;
            var department = document.getElementById("department").value;
            var maxWinners = document.getElementById("maxWinners").value;
            var description = document.getElementById("description").value;

            if (!name) {
                showToast("Draw name is required", false);
                return;
            }
            if (!startDate || !endDate) {
                showToast("Start and End date are required", false);
                return;
            }
            if (totalSeconds <= 0) {
                showToast("Timer must be greater than 0 seconds", false);
                return;
            }
            if (!maxWinners || Number(maxWinners) <= 0) {
                showToast("Max Winners must be > 0", false);
                return;
            }

            var body = {
                name: name,
                prize: prize, // kept same as backend field from create page
                voucherCode: accessVoucher || null,
                voucherAccessLevel: voucherAccessLevel,
                startDate: startDate,
                endDate: endDate,
                description: description,
                department: department,
                timerSeconds: totalSeconds,
                maxWinners: Number(maxWinners)
            };

            var url = "/draws/" + currentDrawId + "?adminId=" + adminId;

            apiFetch(url, "PUT", body)
                .then(function (json) {
                    if (!json || !json.success) {
                        showToast((json && json.message) ? json.message : "Failed to update draw", false);
                        return;
                    }

                    showToast("Draw updated successfully!", true);

                    setTimeout(function () {
                        redirectTo("/admin/view-draws.html");
                    }, 900);
                });
        }
    </script>

</body>
</html>
