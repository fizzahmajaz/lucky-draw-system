<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>History</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/css/style.css">

    <style>
        body { background: linear-gradient(135deg, #fdf2f8, #eff6ff); min-height: 100vh; }
        .user-shell { display: flex; min-height: 100vh; }

        /* SIDEBAR */
        .user-sidebar {
            width: 260px;
            background: linear-gradient(180deg, #2563eb, #22c1c3);
            color: white; padding: 22px 18px;
            display: flex; flex-direction: column;
        }

        .user-logo {
            display: flex; align-items: center;
            gap: 10px; margin-bottom: 30px;
        }

        .user-logo-icon {
            width: 36px; height: 36px;
            border-radius: 999px;
            background: rgba(255,255,255,0.2);
            display:flex; align-items:center; justify-content:center;
        }

        .user-nav { flex: 1; }
        .user-nav-item {
            padding: 10px 12px; border-radius: 12px;
            display: flex; align-items:center;
            gap: 10px; margin-bottom: 6px;
            cursor: pointer; font-size: 15px;
        }
        .user-nav-item:hover { background: rgba(255,255,255,0.12); }
        .user-nav-active { background: rgba(255,255,255,0.2); }

        /* MAIN */
        .user-main { flex: 1; padding: 22px 26px; }

        .page-title-row {
            display: flex; justify-content: space-between;
            align-items: flex-end; margin-bottom: 18px;
        }
        .subtitle { color: #64748b; font-size: 13px; }

        .filter-pill {
            border-radius: 999px; padding: 6px 14px;
            background: white; font-size: 13px;
            border: 1px solid #e5e7eb;
            cursor: pointer; margin-right: 6px;
        }
        .filter-pill-active {
            background: #1d4ed8; color: white;
            border-color: #1d4ed8;
        }

        .toggle-btn {
            border-radius: 999px; padding: 6px 15px;
        }

        .history-card {
            background: white; border-radius: 20px;
            box-shadow: 0 8px 22px rgba(0,0,0,0.06);
            padding: 18px 20px; margin-bottom: 14px;
        }
        .history-card:hover { transform: translateY(-3px); transition: .2s; }

        .badge-won {
            background: #dcfce7; color:#166534;
            border-radius: 999px; padding: 4px 10px;
            font-size: 11px; font-weight: 600;
        }
        .badge-lost {
            background: #fee2e2; color:#991b1b;
            border-radius: 999px; padding:4px 10px;
            font-size: 11px; font-weight:600;
        }

        .empty-box {
            background: #f8fafc; padding: 28px;
            border-radius: 20px; text-align:center;
            color: #6b7280;
        }
    </style>
</head>

<body>

<div class="toast-box" id="toast-box"></div>

<div class="user-shell">

    <!-- SIDEBAR -->
    <div class="user-sidebar">
        <div class="user-logo">
            <div class="user-logo-icon">üïë</div>
            <div>User Panel</div>
        </div>

        <div class="user-nav">
            <div class="user-nav-item" onclick="redirectTo('/user/dashboard.html')">
                <span>üè†</span> Dashboard
            </div>
            <div class="user-nav-item" onclick="redirectTo('/user/draws.html')">
                <span>üéü</span> Available Draws
            </div>
            <div class="user-nav-item" onclick="redirectTo('/user/joined.html')">
                <span>üìå</span> Joined Draws
            </div>
            <div class="user-nav-item" onclick="redirectTo('/user/winners.html')">
                <span>üèÜ</span> My Wins
            </div>
            <div class="user-nav-item user-nav-active">
                <span>üïë</span> History
            </div>
            <div class="user-nav-item" onclick="redirectTo('/user/profile.html')">
                <span>üë§</span> Profile
            </div>
            <div class="user-nav-item" onclick="logoutUser()">
                <span>üö™</span> Logout
            </div>
        </div>
    </div>

    <!-- MAIN -->
    <div class="user-main">

        <div class="page-title-row">
            <div>
                <h3>History</h3>
                <div class="subtitle">All your joined, won, and lost draws.</div>
            </div>

            <div>
                <button class="btn btn-sm btn-outline-secondary me-2" onclick="exportHistory('csv')">CSV</button>
                <button class="btn btn-sm btn-outline-secondary" onclick="exportHistory('pdf')">PDF</button>
            </div>
        </div>

        <!-- FILTERS -->
        <div class="mb-3 d-flex align-items-center">
            <div id="f_all" class="filter-pill filter-pill-active" onclick="setFilter('all')">All</div>
            <div id="f_won" class="filter-pill" onclick="setFilter('won')">Won</div>
            <div id="f_lost" class="filter-pill" onclick="setFilter('lost')">Lost</div>
            <div id="f_active" class="filter-pill" onclick="setFilter('active')">Active</div>
            <div id="f_ended" class="filter-pill" onclick="setFilter('ended')">Ended</div>
        </div>

        <!-- VIEW TOGGLE -->
        <div class="mb-3 text-end">
            <button class="btn btn-sm btn-outline-dark toggle-btn" onclick="toggleView('table')">Table</button>
            <button class="btn btn-sm btn-outline-dark toggle-btn" onclick="toggleView('card')">Cards</button>
        </div>

        <!-- HISTORY CONTENT -->
        <div id="historyContainer"></div>

    </div>
</div>


<!-- MODAL -->
<div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" style="border-radius:18px;">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Details</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">Loading...</div>
        </div>
    </div>
</div>


<script src="/assets/js/common.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>

var userId = null;
var filter = "all";
var viewMode = "card";
var historyList = [];

window.onload = function () {

    try { userId = localStorage.getItem("userId"); } catch(e) {}

    if (!userId) { redirectTo('/user/login.html'); return; }

    loadHistory();
};

function loadHistory() {
    apiFetch("/users/" + userId + "/draws/joined", "GET")
      .then(function(res) {

        if (!res || !res.success || !res.data) {
            showToast("Unable to load history", false);
            return;
        }

        historyList = res.data;
        renderHistory();
      });
}

function renderHistory() {
    var box = document.getElementById("historyContainer");
    box.innerHTML = "";

    if (!historyList || historyList.length === 0) {
        box.innerHTML = "<div class='empty-box'>No draw history found.</div>";
        return;
    }

    var f = filter;

    var filtered = [];
    var i;

    for (i = 0; i < historyList.length; i++) {
        var h = historyList[i];
        if (!h) continue;

        var isWinner = (h.winner === true);
        var ended = true;

        if (h.endDate) {
            var dt = new Date(h.endDate).getTime();
            ended = dt < Date.now();
        }

        if (f === "won" && !isWinner) continue;
        if (f === "lost" && isWinner) continue;
        if (f === "active" && ended) continue;
        if (f === "ended" && !ended) continue;

        filtered.push(h);
    }

    if (filtered.length === 0) {
        box.innerHTML = "<div class='empty-box'>No results match your filter.</div>";
        return;
    }

    if (viewMode === "table") {
        renderTable(filtered);
    } else {
        renderCards(filtered);
    }
}

function renderTable(list) {
    var box = document.getElementById("historyContainer");

    var html = "<div class='table-responsive'>" +
        "<table class='table table-hover'>" +
        "<thead><tr>" +
        "<th>Draw</th>" +
        "<th>Prize</th>" +
        "<th>Status</th>" +
        "<th>Joined</th>" +
        "<th>Details</th>" +
        "</tr></thead><tbody>";

    var i;
    for (i = 0; i < list.length; i++) {
        var h = list[i];
        var nm = h.drawName || "Draw";

        var prize = h.prizeType || "-";
        if (h.prizeAmount) prize += " ‚Ä¢ " + h.prizeAmount;

        var badge = h.winner
            ? "<span class='badge-won'>WINNER</span>"
            : "<span class='badge-lost'>Lost</span>";

        var joinedAt = h.joinedAt ? formatDateTime(h.joinedAt) : "-";

        html += "<tr>" +
            "<td>" + escapeHtml(nm) + "</td>" +
            "<td>" + escapeHtml(prize) + "</td>" +
            "<td>" + badge + "</td>" +
            "<td>" + joinedAt + "</td>" +
            "<td><button class='btn btn-sm btn-outline-dark' onclick='openDetail(" + h.drawId + ")'>View</button></td>" +
            "</tr>";
    }

    html += "</tbody></table></div>";

    box.innerHTML = html;
}

function renderCards(list) {
    var box = document.getElementById("historyContainer");

    var i;
    for (i = 0; i < list.length; i++) {
        var h = list[i];

        var nm = h.drawName || "Draw";

        var prize = h.prizeType || "-";
        if (h.prizeAmount) prize += " ‚Ä¢ " + h.prizeAmount;

        var badge = h.winner
            ? "<span class='badge-won'>WINNER</span>"
            : "<span class='badge-lost'>Lost</span>";

        var joinedAt = h.joinedAt ? formatDateTime(h.joinedAt) : "-";

        var card = document.createElement("div");
        card.className = "history-card";

        card.innerHTML =
            "<div class='d-flex justify-content-between'>" +
            "<div>" +
            "<h5>" + escapeHtml(nm) + "</h5>" +
            "<div class='text-muted'><b>Prize:</b> " + escapeHtml(prize) + "</div>" +
            "<div class='text-muted'><b>Joined:</b> " + joinedAt + "</div>" +
            "</div>" +
            "<div class='text-end'>" +
            badge +
            "<br><br>" +
            "<button class='btn btn-sm btn-outline-dark' onclick='openDetail(" + h.drawId + ")'>Details</button>" +
            "</div>" +
            "</div>";

        box.appendChild(card);
    }
}

function openDetail(drawId) {
    apiFetch("/draws/" + drawId, "GET")
        .then(function(json) {
            if (!json || !json.success || !json.data) return;

            var d = json.data;
            document.getElementById("modalTitle").innerText = d.name;

            var html =
                "<b>Prize Type:</b> " + escapeHtml(d.prizeType) + "<br>" +
                "<b>Prize Amount:</b> " + escapeHtml(d.prizeAmount) + "<br><br>" +
                "<b>Description:</b><br>" + escapeHtml(d.description) + "<br><br>" +
                "<b>Start:</b> " + formatDateTime(d.startDate) + "<br>" +
                "<b>End:</b> " + formatDateTime(d.endDate);

            document.getElementById("modalBody").innerHTML = html;

            var m = new bootstrap.Modal(document.getElementById("historyModal"));
            m.show();
        });
}

function setFilter(f) {
    filter = f;

    var ids = ["f_all","f_won","f_lost","f_active","f_ended"];
    var i;
    for (i = 0; i < ids.length; i++) {
        document.getElementById(ids[i]).classList.remove("filter-pill-active");
    }
    document.getElementById("f_" + f).classList.add("filter-pill-active");

    renderHistory();
}

function toggleView(v) {
    viewMode = v;
    renderHistory();
}

function exportHistory(fmt) {
    redirectTo("/users/" + userId + "/draws/history/export?format=" + fmt);
}

function formatDateTime(iso) {
    if (!iso) return "-";
    var d = new Date(iso);
    if (isNaN(d.getTime())) return iso;

    var day = d.getDate(); if (day < 10) day = "0"+day;
    var mn = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][d.getMonth()];
    var year = d.getFullYear();
    var h = d.getHours();
    var m = d.getMinutes();
    var am = h >= 12 ? "PM":"AM";
    h = h%12; if (h===0) h=12;
    if (m<10) m="0"+m;

    return day+" "+mn+" "+year+", "+h+":"+m+" "+am;
}

function escapeHtml(s){
    if (!s) return "";
    return String(s)
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;");
}

function logoutUser(){
    localStorage.clear();
    redirectTo('/user/login.html');
}

function redirectTo(url){ window.location.href = url; }

</script>

</body>
</html>
