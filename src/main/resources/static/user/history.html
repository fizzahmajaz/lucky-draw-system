<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Draw History</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/css/style.css">

    <style>
        body { background: #f1f5f9; }

        .sidebar {
            width: 240px;
            background: white;
            height: 100vh;
            position: fixed;
            left: 0; top: 0;
            padding: 20px;
            box-shadow: 0 6px 20px rgba(0,0,0,.08);
        }

        .sidebar-item {
            padding: 12px 16px;
            border-radius: 14px;
            margin-bottom: 6px;
            cursor: pointer;
        }
        .sidebar-item:hover { background: #f3f4f6; }
        .sidebar-active { background: #e6f0ff; }

        .content {
            margin-left: 260px;
            padding: 30px;
        }

        .history-card {
            background: white;
            padding: 20px;
            border-radius: 18px;
            box-shadow: 0 5px 18px rgba(0,0,0,.08);
            cursor: pointer;
            transition: .2s;
        }
        .history-card:hover { transform: translateY(-3px); }

        .won { border-left: 6px solid #16a34a; background: #ecfdf5; }
        .lost { border-left: 6px solid #dc2626; background: #fef2f2; }
        .ended { border-left: 6px solid #6b7280; opacity: 0.7; }
        .running { border-left: 6px solid #3b82f6; }

        /* Modal */
        .modal-content {
            border-radius: 16px;
            padding: 10px;
        }
    </style>
</head>

<body>

    <!-- Sidebar -->
    <div class="sidebar">
        <h4 class="mb-4">User Panel</h4>

        <div class="sidebar-item" onclick="redirectTo('/user/dashboard.html')">Dashboard</div>
        <div class="sidebar-item" onclick="redirectTo('/user/draws.html')">Available Draws</div>
        <div class="sidebar-item" onclick="redirectTo('/user/joined.html')">Joined Draws</div>
        <div class="sidebar-item" onclick="redirectTo('/user/winners.html')">Winners</div>
        <div class="sidebar-item sidebar-active">History</div>
        <div class="sidebar-item" onclick="redirectTo('/user/profile.html')">Profile</div>
        <div class="sidebar-item" onclick="logoutUser()">Logout</div>
    </div>

    <!-- Main Content -->
    <div class="content">

        <h2 class="mb-4">Draw History</h2>

        <!-- Filters + Export -->
        <div class="card-apple p-3 mb-4">
            <div class="row g-3">
                <div class="col-md-3">
                    <select class="form-control" id="filterHistory" onchange="applyFilters()">
                        <option value="">All Draws</option>
                        <option value="WON">Won</option>
                        <option value="LOST">Lost</option>
                        <option value="RUNNING">Running</option>
                        <option value="ENDED">Ended</option>
                    </select>
                </div>

                <div class="col-md-3 text-end">
                    <button class="btn btn-dark" onclick="exportCsv()">CSV</button>
                </div>

                <div class="col-md-3 text-end">
                    <button class="btn btn-danger" onclick="exportPdf()">PDF</button>
                </div>
            </div>
        </div>

        <!-- Draw Cards -->
        <div id="historyBox" class="row g-3"></div>

    </div>

    <!-- MODAL FOR DRAW DETAILS -->
    <div class="modal fade" id="detailsModal">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 id="modalTitle"></h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body" id="modalBody">
                    Loading...
                </div>

            </div>
        </div>
    </div>

    <script src="/assets/js/common.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        var userId = localStorage.getItem("userId");
        if (!userId) redirectTo('/user/login.html');

        var allHistory = [];

        window.onload = function () {
            loadHistory();
        };

        function loadHistory() {
            apiFetch("/users/" + userId + "/draws/joined", "GET")
                .then(function (json) {

                    if (!json || !json.success) return;

                    allHistory = json.data;
                    renderHistory(allHistory);
                });
        }

        function renderHistory(list) {
            var box = document.getElementById("historyBox");
            box.innerHTML = "";

            for (var i = 0; i < list.length; i++) {
                var d = list[i];

                var className = "history-card ";
                if (d.userWon) className += "won";
                else if (d.status === "ENDED") className += "lost";
                else if (d.status === "RUNNING") className += "running";
                else className += "ended";

                var statusBadge = d.userWon ?
                    "<span class='badge bg-success'>Won</span>" :
                    d.status === "RUNNING" ?
                        "<span class='badge bg-primary'>Running</span>" :
                        d.status === "ENDED" ?
                            "<span class='badge bg-secondary'>Ended</span>" :
                            "<span class='badge bg-danger'>Lost</span>";

                var card =
                    "<div class='col-md-4'>" +
                    " <div class='" + className + "' onclick='openDetails(" + d.id + ")'>" +
                    "   <h5>" + d.name + "</h5>" +
                    "   " + statusBadge + "<br>" +
                    "   <small>Joined: " + d.joinedAt + "</small><br>" +
                    "   <small>Ends: " + (d.endDate || '-') + "</small>" +
                    " </div>" +
                    "</div>";

                box.innerHTML += card;
            }
        }

        function applyFilters() {
            var f = document.getElementById("filterHistory").value;
            var filtered = [];

            for (var i = 0; i < allHistory.length; i++) {
                var d = allHistory[i];

                if (f === "") filtered.push(d);
                else if (f === "WON" && d.userWon) filtered.push(d);
                else if (f === "LOST" && !d.userWon && d.status === "ENDED") filtered.push(d);
                else if (f === "RUNNING" && d.status === "RUNNING") filtered.push(d);
                else if (f === "ENDED" && d.status === "ENDED") filtered.push(d);
            }

            renderHistory(filtered);
        }

        function openDetails(drawId) {
            // Get draw full details
            apiFetch("/draws/" + drawId, "GET")
                .then(function (json) {

                    if (!json || !json.success) return;

                    var d = json.data;

                    document.getElementById("modalTitle").innerText = d.name;

                    var html =
                        "<b>Prize Type:</b> " + d.prizeType + "<br>" +
                        "<b>Prize Amount:</b> " + (d.prizeAmount || '-') + "<br>" +
                        "<b>Voucher:</b> " + (d.voucherCode || '-') + "<br>" +
                        "<b>Description:</b> " + (d.description || '-') + "<br>" +
                        "<b>Department:</b> " + (d.department || '-') + "<br>" +
                        "<b>Start:</b> " + d.startDate + "<br>" +
                        "<b>End:</b> " + d.endDate + "<br><hr>" +
                        "<h6>Winners:</h6>";

                    apiFetch("/draws/" + drawId + "/winners", "GET")
                        .then(function (json2) {

                            if (!json2 || !json2.success) return;

                            var winners = json2.data.content;

                            for (var i = 0; i < winners.length; i++) {
                                var w = winners[i];
                                var highlight = w.userId == userId ? "style='color:green;font-weight:bold;'" : "";

                                html += "<div " + highlight + ">" + w.userName + " (" + (w.email || '-') + ")</div>";
                            }

                            document.getElementById("modalBody").innerHTML = html;
                            var modal = new bootstrap.Modal(document.getElementById('detailsModal'));
                            modal.show();
                        });
                });
        }

        function exportCsv() {
            redirectTo("/users/" + userId + "/draws/history/export?format=csv");
        }

        function exportPdf() {
            redirectTo("/users/" + userId + "/draws/history/export?format=pdf");
        }

        function redirectTo(a) { window.location.href = a; }
        function logoutUser() {
            localStorage.removeItem("userId");
            redirectTo("/user/login.html");
        }
    </script>

</body>

</html>
