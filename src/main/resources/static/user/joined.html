<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Joined Draws</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">

    <!-- Global CSS -->
    <link rel="stylesheet" href="/assets/css/style.css">

    <style>
        body {
            background: linear-gradient(135deg, #eef2ff, #fdf2f8);
            min-height: 100vh;
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        .user-shell {
            display: flex;
            min-height: 100vh;
        }

        /* SIDEBAR */
        .user-sidebar {
            width: 260px;
            background: linear-gradient(180deg, #2563eb, #22c1c3);
            color: white;
            padding: 22px 18px;
            display: flex;
            flex-direction: column;
        }

        .user-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 30px;
            font-weight: 700;
            font-size: 20px;
        }

        .user-logo-icon {
            width: 36px;
            height: 36px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-nav-item {
            padding: 10px 12px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
        }

        .user-nav-active {
            background: rgba(255, 255, 255, 0.25);
        }

        /* MAIN */
        .user-main {
            flex: 1;
            padding: 26px 30px;
        }

        .stat-box {
            border-radius: 18px;
            padding: 18px;
            background: white;
            box-shadow: 0 5px 16px rgba(0, 0, 0, 0.06);
        }

        table {
            background: white;
            border-radius: 16px;
            overflow: hidden;
        }

        th {
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: #6b7280;
        }

        .empty-box {
            padding: 25px;
            text-align: center;
            color: #6b7280;
            font-size: 15px;
        }
    </style>
</head>

<body>

    <div class="toast-box" id="toast-box"></div>

    <div class="user-shell">

        <!-- SIDEBAR -->
        <div class="user-sidebar">
            <div class="user-logo">
                <div class="user-logo-icon">üìå</div> <div>User Panel</div>
            </div>

            <div class="user-nav">
                <div class="user-nav-item" onclick="redirectTo('/user/dashboard.html')">üè† Dashboard</div>
                <div class="user-nav-item" onclick="redirectTo('/user/draws.html')">üéü Available Draws</div>
                <div class="user-nav-item user-nav-active">üìå Joined Draws</div>
                <div class="user-nav-item" onclick="redirectTo('/user/winners.html')">üèÜ My Wins</div>
                <div class="user-nav-item" onclick="redirectTo('/user/history.html')">üïë History</div>
                <div class="user-nav-item" onclick="redirectTo('/user/profile.html')">üë§ Profile</div>
                <div class="user-nav-item" onclick="logoutUser()">üö™ Logout</div>
            </div>

        </div>

        <!-- MAIN CONTENT -->
        <div class="user-main">

            <h2 class="fw-bold mb-2">Joined Draws</h2>
            <p class="text-muted mb-4">Overview of all draws you have participated in.</p>

            <!-- Stats -->
            <div class="row g-3 mb-4">
                <div class="col-md-3 col-6">
                    <div class="stat-box">
                        <div class="stat-label">Total Joined</div>
                        <div class="stat-value fs-3" id="statJoined">0</div>
                    </div>
                </div>

                <div class="col-md-3 col-6">
                    <div class="stat-box">
                        <div class="stat-label">Active</div>
                        <div class="stat-value fs-3" id="statActive">0</div>
                    </div>
                </div>

                <div class="col-md-3 col-6">
                    <div class="stat-box">
                        <div class="stat-label">Ended</div>
                        <div class="stat-value fs-3" id="statEnded">0</div>
                    </div>
                </div>

                <div class="col-md-3 col-6">
                    <div class="stat-box">
                        <div class="stat-label">Wins</div>
                        <div class="stat-value fs-3" id="statWins">0</div>
                    </div>
                </div>
            </div>

            <!-- TABLE -->
            <div class="table-responsive">
                <table class="table table-bordered align-middle shadow-sm">
                    <thead>
                        <tr>
                            <th>DRAW</th>
                            <th>PRIZE</th>
                            <th>EMAIL</th>
                            <th>JOINED AT</th>
                            <th>STATUS</th>
                        </tr>
                    </thead>
                    <tbody id="joinedTable"></tbody>
                </table>
            </div>

        </div>

    </div>

    <script src="/assets/js/common.js"></script>

    <script>
        let userId = null;

        window.onload = function () {
            userId = localStorage.getItem("userId");
            if (!userId) redirectTo("/user/login.html");
            loadJoinedDraws();
        };

        function loadJoinedDraws() {

            apiFetch("/admins/participants/all", "GET")
                .then(res => {
                    if (!res || !res.success) {
                        showToast("Failed to load joined draws", false);
                        return;
                    }

                    let all = res.data || [];
                    let list = all.filter(x => x.userId == userId);

                    document.getElementById("statJoined").innerText = list.length;

                    let active = list.filter(x => x.drawStatus === "ACTIVE").length;
                    let ended = list.filter(x => x.drawStatus === "ENDED").length;
                    let wins = list.filter(x => x.winner === true).length;

                    document.getElementById("statActive").innerText = active;
                    document.getElementById("statEnded").innerText = ended;
                    document.getElementById("statWins").innerText = wins;

                    renderTable(list);
                });
        }

        function renderTable(list) {
            let tbody = document.getElementById("joinedTable");
            tbody.innerHTML = "";

            if (list.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="empty-box">You have not joined any draws yet.</td></tr>`;
                return;
            }

            list.forEach(item => {
                let tr = document.createElement("tr");

                tr.innerHTML = `
                    <td>${item.drawName}</td>
                    <td>${item.prize || '-'}</td>
                    <td>${item.email || '-'}</td>
                    <td>${formatDate(item.joinedAt)}</td>
                    <td><span class="badge bg-primary">${item.winner ? "Winner" : "Joined"}</span></td>
                `;

                tbody.appendChild(tr);
            });
        }

        function formatDate(dt) {
            if (!dt) return "-";
            let d = new Date(dt);
            return d.toLocaleString();
        }

        function logoutUser() {
            localStorage.clear();
            redirectTo("/user/login.html");
        }

        function redirectTo(url) {
            window.location.href = url;
        }

    </script>

</body>

</html>
