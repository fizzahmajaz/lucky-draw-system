<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Joined Draws</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/css/style.css">

    <style>
        body {
            background: #f1f5f9;
        }

        .sidebar {
            width: 240px;
            background: white;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            padding: 20px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, .08);
        }

        .sidebar-item {
            padding: 12px 16px;
            margin-bottom: 6px;
            border-radius: 14px;
            cursor: pointer;
        }

        .sidebar-item:hover {
            background: #f3f4f6;
        }

        .sidebar-active {
            background: #e6f0ff;
        }

        .content {
            margin-left: 260px;
            padding: 30px;
        }

        .draw-card {
            background: white;
            padding: 20px;
            border-radius: 18px;
            box-shadow: 0 5px 18px rgba(0, 0, 0, .08);
            cursor: pointer;
            transition: .2s;
        }

        .draw-card:hover {
            transform: translateY(-3px);
        }

        .draw-running {
            border-left: 5px solid #3b82f6;
        }

        .draw-ended {
            opacity: 0.6;
            background: #f8fafc;
        }

        .draw-won {
            border-left: 6px solid #16a34a;
            background: #ecfdf5;
            box-shadow: 0 4px 18px rgba(16, 185, 129, 0.3);
        }

        .draw-lost {
            background: #fef2f2;
            border-left: 5px solid #dc2626;
        }
    </style>
</head>

<body>

    <div class="sidebar">
        <h4 class="mb-4">User Panel</h4>

        <div class="sidebar-item" onclick="redirectTo('/user/dashboard.html')">Dashboard</div>
        <div class="sidebar-item" onclick="redirectTo('/user/draws.html')">Available Draws</div>
        <div class="sidebar-item sidebar-active">Joined Draws</div>
        <div class="sidebar-item" onclick="redirectTo('/user/winners.html')">Winners</div>
        <div class="sidebar-item" onclick="redirectTo('/user/history.html')">History</div>
        <div class="sidebar-item" onclick="redirectTo('/user/profile.html')">Profile</div>
        <div class="sidebar-item" onclick="logoutUser()">Logout</div>
    </div>

    <div class="content">

        <h2 class="mb-4">Joined Draws</h2>

        <!-- Filters -->
        <div class="card-apple mb-4 p-3">
            <div class="row g-3">

                <div class="col-md-3">
                    <select id="filterJoined" class="form-control" onchange="applyFilters()">
                        <option value="">All</option>
                        <option value="RUNNING">Running</option>
                        <option value="ENDED">Ended</option>
                        <option value="WON">Won</option>
                        <option value="LOST">Lost</option>
                    </select>
                </div>

                <div class="col-md-3 text-end">
                    <button class="btn btn-dark" onclick="exportCsv()">CSV</button>
                </div>

                <div class="col-md-3 text-end">
                    <button class="btn btn-danger" onclick="exportPdf()">PDF</button>
                </div>

            </div>
        </div>

        <!-- Draws List -->
        <div id="joinedBox" class="row g-3"></div>

    </div>

    <script src="/assets/js/common.js"></script>

    <script>
        var userId = localStorage.getItem("userId");
        var allJoined = [];

        if (!userId) redirectTo("/user/login.html");

        window.onload = function () {
            loadJoined();
        };

        function loadJoined() {
            apiFetch("/users/" + userId + "/draws/joined", "GET")
                .then(function (json) {
                    if (!json || !json.success) return;

                    allJoined = json.data; 
                    renderJoined(allJoined);
                });
        }

        function renderJoined(list) {
            var box = document.getElementById("joinedBox");
            box.innerHTML = "";

            for (var i = 0; i < list.length; i++) {
                var d = list[i];

                var status = d.status;
                var userWon = d.userWon;

                var className = "draw-card";

                if (userWon) className += " draw-won";
                else if (status === "RUNNING") className += " draw-running";
                else if (status === "ENDED") className += " draw-ended";
                else className += " draw-lost";

                var statusBadge = userWon ?
                    "<span class='badge bg-success'>You Won</span>" :
                    status === "RUNNING" ?
                        "<span class='badge bg-primary'>Running</span>" :
                        status === "ENDED" ?
                            "<span class='badge bg-secondary'>Ended</span>" :
                            "<span class='badge bg-danger'>Lost</span>";

                var card =
                    "<div class='col-md-4'>" +
                    "  <div class='" + className + "' onclick='openDetails(" + d.id + ")'>" +
                    "    <h5>" + d.name + "</h5>" +
                    "    " + statusBadge + "<br>" +
                    "    <small>Joined: " + d.joinedAt + "</small><br>" +
                    "    <small>Ends: " + (d.endDate || '-') + "</small>" +
                    "  </div>" +
                    "</div>";

                box.innerHTML += card;
            }
        }

        function applyFilters() {
            var f = document.getElementById("filterJoined").value;
            var filtered = [];

            for (var i = 0; i < allJoined.length; i++) {
                var d = allJoined[i];

                if (f === "") filtered.push(d);
                else if (f === "WON" && d.userWon) filtered.push(d);
                else if (f === "LOST" && !d.userWon && d.status === "ENDED") filtered.push(d);
                else if (f === "RUNNING" && d.status === "RUNNING") filtered.push(d);
                else if (f === "ENDED" && d.status === "ENDED") filtered.push(d);
            }

            renderJoined(filtered);
        }

        function openDetails(id) {
            // We will build this modal in step 7
            redirectTo("/user/draw-details.html?id=" + id);
        }

        function exportCsv() {
            redirectTo("/users/" + userId + "/draws/history/export?format=csv");
        }

        function exportPdf() {
            redirectTo("/users/" + userId + "/draws/history/export?format=pdf");
        }

        function logoutUser() {
            localStorage.removeItem("userId");
            redirectTo("/user/login.html");
        }

        function redirectTo(a) {
            window.location.href = a;
        }
    </script>

</body>

</html>
