<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Guest Access</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/css/style.css">

    <style>
        body { background:#f6f7fb; }
        .card-apple {
            background:white; border-radius:20px; padding:25px;
            box-shadow:0 8px 30px rgba(0,0,0,0.06);
        }
        .title { font-size:26px; font-weight:700; }
        .switch { color:#007AFF; cursor:pointer; }
    </style>
</head>
<body>

<div class="toast-box" id="toast-box"></div>

<div class="container py-5" style="max-width:480px;">

    <div class="card-apple">

        <!-- REGISTER -->
        <div id="regBox">
            <div class="title">Guest Access</div>
            <div class="text-muted mb-3">Register as guest to continue.</div>

            <input id="gName" class="form-control mb-3" placeholder="Name">
            <input id="gEmail" class="form-control mb-3" placeholder="Email">
            <input id="gPhone" class="form-control mb-3" placeholder="Phone (optional)">
            <input id="gDept" class="form-control mb-3" placeholder="Department (optional)">

            <button class="btn btn-dark w-100" onclick="registerGuest()">Continue as Guest</button>

            <div class="text-center mt-3">
                Already visited? <span class="switch" onclick="switchMode()">Login</span>
            </div>
        </div>

        <!-- LOGIN -->
        <div id="loginBox" style="display:none;">
            <div class="title">Guest Login</div>
            <div class="text-muted mb-3">Enter your email to continue.</div>

            <input id="loginEmail" class="form-control mb-3" placeholder="guest@example.com">

            <button class="btn btn-dark w-100" onclick="loginGuest()">Login</button>

            <div class="text-center mt-3">
                New guest? <span class="switch" onclick="switchMode()">Register</span>
            </div>
        </div>

    </div>
</div>

<script src="/assets/js/common.js"></script>

<script>
function switchMode(){
    var r=document.getElementById("regBox");
    var l=document.getElementById("loginBox");
    if(r.style.display==="none"){ r.style.display="block"; l.style.display="none"; }
    else{ r.style.display="none"; l.style.display="block"; }
}

// ---------------------------
// GUEST REGISTER
// ---------------------------
async function registerGuest(){
    var name=document.getElementById("gName").value.trim();
    var email=document.getElementById("gEmail").value.trim();
    var phone=document.getElementById("gPhone").value.trim();
    var dept=document.getElementById("gDept").value.trim();

    if(!name || !email){
        showToast("Name & Email required", false);
        return;
    }

    var body={
        name:name,
        email:email,
        phone:phone===""?null:phone,
        department:dept===""?null:dept
    };

    var json=await apiFetch("/users/guest","POST",body);

    if(!json || !json.success){
        let msg=json && json.message ? json.message : "Guest registration failed";
        if(msg.toLowerCase().indexOf("duplicate") !== -1){
            msg="This email already exists. Use Login instead.";
        }
        showToast(msg,false);
        return;
    }

    var user=json.data;

    localStorage.setItem("userId",user.id);
    localStorage.setItem("username",user.name);
    localStorage.setItem("isGuest","true");

    showToast("Welcome!",true);

    setTimeout(function(){
        window.location.href="/user/guest-dashboard.html";
    },700);
}

// ---------------------------
// GUEST LOGIN (Email only)
// ---------------------------
async function loginGuest(){
    var email=document.getElementById("loginEmail").value.trim();
    if(!email){
        showToast("Enter your email",false);
        return;
    }

    // Backend does NOT provide GET /users
    // So we login guest by REGISTERING AGAIN with same email -> backend returns duplicate error
    // We detect guest from error message
    var dummy={
        name:"Guest",
        email:email,
        phone:null,
        department:null
    };

    var json=await apiFetch("/users/guest","POST",dummy);

    if(json && json.success){
        // New guest created
        var user=json.data;
        localStorage.setItem("userId",user.id);
        localStorage.setItem("username",user.name);
        localStorage.setItem("isGuest","true");
        showToast("Welcome!",true);
        setTimeout(function(){
            window.location.href="/user/guest-dashboard.html";
        },700);
    }
    else{
        // If duplicate email = existing guest
        var msg=json && json.message ? json.message.toLowerCase() : "";
        if(msg.indexOf("duplicate")!==-1){
            showToast("Welcome back!",true);

            // Simulate login by email only (local storage only)
            localStorage.setItem("username","Guest User");
            localStorage.setItem("isGuest","true");

            // We need userId → we cannot fetch it → we give a temp ID for session only
            localStorage.setItem("userId","999999"); 

            setTimeout(function(){
                window.location.href="/user/guest-dashboard.html";
            },700);
        } else {
            showToast("Guest login failed",false);
        }
    }
}
</script>

</body>
</html>
