<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Your Wins</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/css/style.css">

    <style>
        body {
            background: #f1f5f9;
        }

        /* Sidebar */
        .sidebar {
            width: 240px;
            background: white;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            padding: 20px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, .08);
        }

        .sidebar-item {
            padding: 12px 16px;
            border-radius: 14px;
            margin-bottom: 6px;
            cursor: pointer;
        }

        .sidebar-item:hover {
            background: #f3f4f6;
        }

        .sidebar-active {
            background: #e6f0ff;
        }

        /* Content */
        .content {
            margin-left: 260px;
            padding: 30px;
        }

        /* Winner Card */
        .winner-card {
            background: #ecfdf5;
            border-left: 6px solid #16a34a;
            box-shadow: 0 4px 18px rgba(16, 185, 129, 0.3);
            padding: 20px;
            border-radius: 18px;
        }
    </style>
</head>

<body>

    <!-- Sidebar -->
    <div class="sidebar">
        <h4 class="mb-4">User Panel</h4>

        <div class="sidebar-item" onclick="redirectTo('/user/dashboard.html')">Dashboard</div>
        <div class="sidebar-item" onclick="redirectTo('/user/draws.html')">Available Draws</div>
        <div class="sidebar-item" onclick="redirectTo('/user/joined.html')">Joined Draws</div>
        <div class="sidebar-item sidebar-active">Winners</div>
        <div class="sidebar-item" onclick="redirectTo('/user/history.html')">History</div>
        <div class="sidebar-item" onclick="redirectTo('/user/profile.html')">Profile</div>
        <div class="sidebar-item" onclick="logoutUser()">Logout</div>
    </div>

    <!-- Main Content -->
    <div class="content">

        <h2 class="mb-4">Your Wins</h2>

        <!-- Export -->
        <div class="card-apple p-3 mb-4">
            <div class="text-end">
                <button class="btn btn-dark me-2" onclick="exportCsv()">CSV</button>
                <button class="btn btn-danger" onclick="exportPdf()">PDF</button>
            </div>
        </div>

        <!-- Winner List -->
        <div id="winnerBox" class="row g-3"></div>

    </div>

    <script src="/assets/js/common.js"></script>

    <script>
        var userId = localStorage.getItem("userId");
        if (!userId) redirectTo("/user/login.html");

        window.onload = function () {
            loadWinners();
        };

        function loadWinners() {
            apiFetch("/users/" + userId + "/draws/won", "GET")
                .then(function (json) {

                    if (!json || !json.success) return;

                    var list = json.data;
                    var box = document.getElementById("winnerBox");
                    box.innerHTML = "";

                    for (var i = 0; i < list.length; i++) {
                        var w = list[i];

                        var voucherSection = "";
                        var redeemSection = "";

                        if (w.voucherCode !== null && w.voucherCode !== undefined) {
                            voucherSection =
                                "<div class='mt-2'><strong>Voucher Code:</strong> " +
                                "<span id='voucher_" + w.id + "'>******</span>" +
                                " <button class='btn btn-sm btn-outline-primary' onclick=\"revealVoucher('" + w.id + "', '" + w.voucherCode + "')\">Reveal</button></div>";

                            // Redeem option if not redeemed
                            if (!w.redeemed) {
                                redeemSection =
                                    "<button class='btn btn-success btn-sm mt-2' onclick=\"redeemVoucher('" + w.voucherCode + "', " + w.drawId + ")\">Redeem Now</button>";
                            } else {
                                redeemSection =
                                    "<div class='mt-2 badge bg-success'>Voucher Redeemed</div>";
                            }
                        } else {
                            voucherSection =
                                "<div class='mt-2'><strong>Cash Prize:</strong> " + (w.prizeAmount || '-') + "</div>";

                            redeemSection =
                                "<div class='mt-2 badge bg-info'>Amount will be sent shortly</div>";
                        }

                        var card =
                            "<div class='col-md-4'>" +
                            "  <div class='winner-card'>" +
                            "    <h5>" + w.name + "</h5>" +
                            "    <div><strong>Announced:</strong> " + w.announcedAt + "</div>" +
                            voucherSection +
                            redeemSection +
                            "  </div>" +
                            "</div>";

                        box.innerHTML += card;
                    }
                });
        }

        function revealVoucher(id, code) {
            document.getElementById("voucher_" + id).innerText = code;
        }

        function redeemVoucher(code, drawId) {
            apiFetch("/vouchers/redeem?userId=" + userId + "&drawId=" + drawId + "&code=" + code, "POST")
                .then(function (json) {

                    if (!json || !json.success) {
                        showToast("Unable to redeem voucher", false);
                        return;
                    }

                    showToast("Voucher Redeemed!", true);
                    setTimeout(function () { loadWinners(); }, 800);
                });
        }

        function exportCsv() {
            redirectTo("/users/" + userId + "/draws/history/export?format=csv");
        }

        function exportPdf() {
            redirectTo("/users/" + userId + "/draws/history/export?format=pdf");
        }

        function logoutUser() {
            localStorage.removeItem("userId");
            redirectTo("/user/login.html");
        }

        function redirectTo(a) {
            window.location.href = a;
        }
    </script>

</body>

</html>
