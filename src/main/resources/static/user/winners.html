<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Your Wins</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">

    <!-- Global styles -->
    <link rel="stylesheet" href="/assets/css/style.css">

    <style>
        .header-title {
            font-size: 28px;
            font-weight: 600;
        }

        .win-card {
            border-radius: 20px;
            padding: 20px;
            background: white;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06);
            margin-bottom: 20px;
        }

        .empty-box {
            background: #f8f9fa;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            font-size: 16px;
        }

        .voucher-box {
            padding: 15px;
            border-radius: 15px;
            background: #e9f7ff;
            font-size: 18px;
            text-align: center;
            font-weight: 600;
        }
    </style>
</head>

<body>

<div class="toast-box" id="toast-box"></div>

<div class="container py-4">

    <h2 class="header-title mb-4">Your Wins</h2>

    <div id="winsContainer"></div>

</div>


<!-- Modal for Revealed Voucher -->
<div class="modal fade" id="voucherModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 20px;">
            <div class="modal-header">
                <h5 class="modal-title">Your Voucher Code</h5>
                <button class="btn-close" onclick="closeVoucherModal()"></button>
            </div>
            <div class="modal-body">
                <div class="voucher-box" id="voucherCodeBox">---</div>
            </div>
        </div>
    </div>
</div>



<script src="/assets/js/common.js"></script>

<script>

    var userId = null;

    window.onload = function() {

        try {
            userId = localStorage.getItem("userId");
        } catch (e) { }

        if (!userId) {
            showToast("Please login first", false);
            setTimeout(function () { redirectTo("/user/login.html"); }, 700);
            return;
        }

        loadWins();
    };



    async function loadWins() {

        var json = await apiFetch("/users/" + userId + "/draws/won", "GET");

        if (!json || !json.success) {
            showToast("Failed to load winners", false);
            return;
        }

        var wins = json.data;
        var container = document.getElementById("winsContainer");
        container.innerHTML = "";

        if (!wins || wins.length === 0) {
            container.innerHTML = "<div class='empty-box'>You have not won any draws yet.</div>";
            return;
        }

        for (var i = 0; i < wins.length; i++) {

            var w = wins[i];

            var card = document.createElement("div");
            card.className = "win-card";

            card.innerHTML =
                "<h5>" + (w.drawName || "Draw") + "</h5>" +
                "<div class='text-muted small mb-2'>Announced: " + (w.announcedAt || "-") + "</div>";

            // Prize types
            if (w.prizeType === "CASH") {

                card.innerHTML +=
                    "<div class='text-success fw-bold'>Amount will be sent to your account shortly.</div>";

            } else if (w.prizeType === "VOUCHER") {

                if (w.redeemed === true) {

                    // Already redeemed
                    card.innerHTML +=
                        "<div class='voucher-box mt-3'>Redeemed: " + (w.voucherCode || "-") + "</div>";

                } else {

                    // Show "Reveal Voucher" button
                    card.innerHTML +=
                        "<button class='btn btn-dark mt-3' onclick='revealVoucher(" + w.drawId + ", \"" + (w.voucherCode || "") + "\")'>Reveal Voucher</button>";

                }
            }

            container.appendChild(card);
        }
    }



    // Redeem voucher API call
    async function revealVoucher(drawId, voucherCode) {

        if (!voucherCode || voucherCode === "") {
            showToast("Voucher not available", false);
            return;
        }

        var url = "/vouchers/redeem?userId=" + userId + "&drawId=" + drawId + "&code=" + voucherCode;

        var json = await apiFetch(url, "POST");

        if (!json || !json.success) {
            showToast(json.message || "Failed to redeem voucher", false);
            return;
        }

        // show modal
        document.getElementById("voucherCodeBox").innerText = json.data || voucherCode;

        openVoucherModal();

        // refresh list
        loadWins();
    }



    function openVoucherModal() {
        var modal = new bootstrap.Modal(document.getElementById("voucherModal"));
        modal.show();
    }

    function closeVoucherModal() {
        var modalEl = document.getElementById("voucherModal");
        var modal = bootstrap.Modal.getInstance(modalEl);
        modal.hide();
    }

</script>

</body>
</html>
