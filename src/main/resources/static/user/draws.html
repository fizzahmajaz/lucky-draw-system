<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Available Draws</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/css/style.css">

    <style>
        body {
            background: linear-gradient(135deg, #fdf2f8, #eff6ff);
            min-height: 100vh;
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        .user-shell {
            display: flex;
            min-height: 100vh;
        }

        /* SIDEBAR (same as dashboard) */
        .user-sidebar {
            width: 260px;
            background: linear-gradient(180deg, #2563eb, #22c1c3);
            color: white;
            padding: 22px 18px;
            display: flex;
            flex-direction: column;
        }

        .user-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 30px;
            font-weight: 700;
            font-size: 20px;
        }

        .user-logo-icon {
            width: 36px;
            height: 36px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .user-nav {
            flex: 1;
        }

        .user-nav-item {
            padding: 10px 12px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
            cursor: pointer;
            font-size: 15px;
        }

        .user-nav-item span.icon {
            width: 20px;
            text-align: center;
        }

        .user-nav-item:hover {
            background: rgba(255, 255, 255, 0.12);
        }

        .user-nav-active {
            background: rgba(255, 255, 255, 0.2);
        }

        .user-sidebar-footer {
            font-size: 12px;
            opacity: 0.85;
        }

        /* MAIN */
        .user-main {
            flex: 1;
            padding: 22px 26px;
        }

        .page-title-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 18px;
        }

        .page-title-row h3 {
            margin: 0;
        }

        .subtitle {
            font-size: 13px;
            color: #64748b;
        }

        .stat-box {
            border-radius: 20px;
            padding: 16px 18px;
            background: white;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
        }

        .stat-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
        }

        .filter-row .form-control,
        .filter-row .form-select {
            border-radius: 999px;
        }

        .draw-card {
            border-radius: 20px;
            padding: 18px 20px;
            background: white;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06);
            margin-bottom: 14px;
            transition: 0.2s;
        }

        .draw-card:hover {
            transform: translateY(-3px);
        }

        .draw-pill {
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 999px;
            background: #eef2ff;
            color: #3730a3;
            font-weight: 600;
        }

        .badge-joined {
            background: #dcfce7;
            color: #166534;
            border-radius: 999px;
            padding: 4px 9px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-ending-soon {
            background: #fef3c7;
            color: #92400e;
            border-radius: 999px;
            padding: 4px 9px;
            font-size: 11px;
            font-weight: 600;
        }

        .draw-meta {
            font-size: 12px;
            color: #6b7280;
        }

        .empty-box {
            padding: 26px;
            border-radius: 20px;
            background: #f8fafc;
            text-align: center;
            color: #6b7280;
            font-size: 14px;
        }
    </style>
</head>

<body>

<div class="toast-box" id="toast-box"></div>

<div class="user-shell">

    <!-- SIDEBAR -->
    <div class="user-sidebar">
        <div class="user-logo">
            <div class="user-logo-icon">üéØ</div>
            <div>User Panel</div>
        </div>

        <div class="user-nav">
            <div class="user-nav-item" onclick="redirectTo('/user/dashboard.html')">
                <span class="icon">üè†</span> <span>Dashboard</span>
            </div>
            <div class="user-nav-item user-nav-active" onclick="redirectTo('/user/draws.html')">
                <span class="icon">üéü</span> <span>Available Draws</span>
            </div>
            <div class="user-nav-item" onclick="redirectTo('/user/joined.html')">
                <span class="icon">üìå</span> <span>Joined Draws</span>
            </div>
            <div class="user-nav-item" onclick="redirectTo('/user/winners.html')">
                <span class="icon">üèÜ</span> <span>My Wins</span>
            </div>
            <div class="user-nav-item" onclick="redirectTo('/user/history.html')">
                <span class="icon">üïë</span> <span>History</span>
            </div>
            <div class="user-nav-item" onclick="redirectTo('/user/profile.html')">
                <span class="icon">üë§</span> <span>Profile</span>
            </div>
            <div class="user-nav-item" onclick="logoutUser()">
                <span class="icon">üö™</span> <span>Logout</span>
            </div>
        </div>

        <div class="user-sidebar-footer">
            Pick your luck wisely ‚ú®
        </div>
    </div>

    <!-- MAIN -->
    <div class="user-main">

        <div class="page-title-row">
            <div>
                <h3>Available Draws</h3>
                <div class="subtitle">Join running draws and track your luck in real-time.</div>
            </div>
            <div class="text-end">
                <div class="subtitle">Logged in as</div>
                <div id="userNameDisplay" style="font-weight:600;">User</div>
            </div>
        </div>

        <!-- STATS ROW -->
        <div class="row g-3 mb-3">
            <div class="col-md-3 col-6">
                <div class="stat-box">
                    <div class="stat-label">Available</div>
                    <div class="stat-value" id="statAvailable">0</div>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="stat-box">
                    <div class="stat-label">Joined</div>
                    <div class="stat-value" id="statJoined">0</div>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="stat-box">
                    <div class="stat-label">Ending Soon</div>
                    <div class="stat-value" id="statEndingSoon">0</div>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="stat-box">
                    <div class="stat-label">Your Voucher</div>
                    <div class="stat-value" id="statVoucher">-</div>
                </div>
            </div>
        </div>

        <!-- FILTERS -->
        <div class="d-flex flex-wrap align-items-center justify-content-between mb-3 filter-row">
            <div class="d-flex flex-wrap gap-2">
                <input id="filterSearch" class="form-control form-control-sm" style="max-width:220px;"
                       placeholder="Search (name, prize, voucher)" oninput="renderDrawCards()">

                <select id="filterPrizeType" class="form-select form-select-sm" style="max-width:140px;"
                        onchange="renderDrawCards()">
                    <option value="">Prize type</option>
                    <option value="CASH">Cash Only</option>
                    <option value="VOUCHER">Voucher Only</option>
                </select>

                <select id="filterJoinState" class="form-select form-select-sm" style="max-width:150px;"
                        onchange="renderDrawCards()">
                    <option value="all">All</option>
                    <option value="joined">Joined</option>
                    <option value="notJoined">Not Joined</option>
                </select>

                <input id="filterDate" type="date" class="form-control form-control-sm"
                       style="max-width:150px;" onchange="renderDrawCards()">
            </div>
        </div>

        <!-- DRAW CARDS -->
        <div id="drawsContainer"></div>

    </div> <!-- /user-main -->
</div> <!-- /user-shell -->


<!-- DETAILS MODAL -->
<div class="modal fade" id="drawDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" style="border-radius:18px;">
            <div class="modal-header">
                <h5 class="modal-title" id="detailModalTitle">Draw Details</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detailModalBody">
                Loading...
            </div>
        </div>
    </div>
</div>

<!-- VOUCHER JOIN MODAL (for SPECIFIC access draws) -->
<div class="modal fade" id="joinVoucherModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius:18px;">
            <div class="modal-header">
                <h5 class="modal-title">Join with Access Voucher</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-2">This draw is restricted. Enter your access voucher code.</p>
                <input id="joinVoucherInput" class="form-control" placeholder="Enter voucher code">
                <input type="hidden" id="joinDrawIdHidden">
                <input type="hidden" id="joinExpectedVoucherHidden">
            </div>
            <div class="modal-footer border-0">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-primary" onclick="confirmJoinWithVoucher()">Join Draw</button>
            </div>
        </div>
    </div>
</div>

<script src="/assets/js/common.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    var userId = null;
    var userName = null;
    var userVoucher = null;

    var allActiveDraws = [];
    var joinedDrawIds = {};
    var endingSoonCount = 0;

    window.onload = function () {
        initAvailableDrawsPage();
    };

    function initAvailableDrawsPage() {
        try {
            userId = localStorage.getItem("userId");
            userName = localStorage.getItem("userName");
            userVoucher = localStorage.getItem("userVoucher");
        } catch (e) {
            userId = null;
        }

        if (!userId) {
            redirectTo("/user/login.html");
            return;
        }

        if (!userName || userName === "") userName = "User";
        document.getElementById("userNameDisplay").innerText = userName;

        if (userVoucher && userVoucher !== "") {
            document.getElementById("statVoucher").innerText = userVoucher;
        } else {
            document.getElementById("statVoucher").innerText = "-";
        }

        loadData();
    }

    function loadData() {
        Promise.all([
            apiFetch("/users/" + userId + "/draws/joined", "GET"),
            apiFetch("/draws/active?page=0&size=200", "GET")
        ]).then(function (results) {

            var joinedRes = results[0];
            var activeRes = results[1];

            // Joined map
            joinedDrawIds = {};
            var joinedList = [];
            if (joinedRes && joinedRes.success && joinedRes.data) {
                if (joinedRes.data instanceof Array) {
                    joinedList = joinedRes.data;
                } else if (joinedRes.data.content && joinedRes.data.content instanceof Array) {
                    joinedList = joinedRes.data.content;
                }
            }
            var i;
            for (i = 0; i < joinedList.length; i++) {
                var it = joinedList[i];
                if (!it) continue;
                var dId = null;
                if (it.drawId !== undefined && it.drawId !== null) {
                    dId = it.drawId;
                } else if (it.draw && it.draw.id !== undefined && it.draw.id !== null) {
                    dId = it.draw.id;
                } else if (it.id !== undefined && it.id !== null) {
                    dId = it.id;
                }
                if (dId !== null) joinedDrawIds[dId] = true;
            }

            // Active draws
            allActiveDraws = [];
            if (activeRes && activeRes.success && activeRes.data && activeRes.data.content) {
                allActiveDraws = activeRes.data.content;
            }

            // Sort by ending soon
            allActiveDraws.sort(function (a, b) {
                var t1 = a.endDate ? new Date(a.endDate).getTime() : 9999999999999;
                var t2 = b.endDate ? new Date(b.endDate).getTime() : 9999999999999;
                return t1 - t2;
            });

            // Stats
            document.getElementById("statAvailable").innerText = allActiveDraws.length;
            document.getElementById("statJoined").innerText = Object.keys(joinedDrawIds).length;

            endingSoonCount = 0;
            var now = new Date().getTime();
            var soonWindowMs = 24 * 60 * 60 * 1000;
            for (i = 0; i < allActiveDraws.length; i++) {
                var d = allActiveDraws[i];
                if (d.endDate) {
                    var t = new Date(d.endDate).getTime();
                    if (!isNaN(t) && t > now && (t - now) <= soonWindowMs) {
                        endingSoonCount++;
                    }
                }
            }
            document.getElementById("statEndingSoon").innerText = endingSoonCount;

            renderDrawCards();
        }).catch(function () {
            showToast("Failed to load draws", false);
        });
    }

    function renderDrawCards() {
        var container = document.getElementById("drawsContainer");
        container.innerHTML = "";

        if (!allActiveDraws || allActiveDraws.length === 0) {
            container.innerHTML = "<div class='empty-box'>No active draws available at the moment.</div>";
            return;
        }

        var search = document.getElementById("filterSearch").value.toLowerCase();
        var prizeType = document.getElementById("filterPrizeType").value;
        var joinState = document.getElementById("filterJoinState").value;
        var dateVal = document.getElementById("filterDate").value;

        var visible = 0;
        var i;

        for (i = 0; i < allActiveDraws.length; i++) {
            var d = allActiveDraws[i];

            var isJoined = joinedDrawIds[d.id] === true;

            if (joinState === "joined" && !isJoined) continue;
            if (joinState === "notJoined" && isJoined) continue;

            if (prizeType && d.prizeType && d.prizeType !== prizeType) continue;

            if (dateVal && d.startDate) {
                var startDateOnly = String(d.startDate).substring(0, 10);
                if (startDateOnly !== dateVal) continue;
            }

            var combined = ((d.name || "") + " " +
                (d.prizeType || "") + " " +
                (d.prizeAmount || "") + " " +
                (d.voucherCode || "") + " " +
                (d.description || "")).toLowerCase();

            if (search && combined.indexOf(search) === -1) continue;

            visible++;

            var prizeText;
            if (d.prizeType === "CASH") {
                prizeText = "Cash ‚Ä¢ " + (d.prizeAmount || "");
            } else if (d.prizeType === "VOUCHER") {
                prizeText = "Voucher ‚Ä¢ " + (d.voucherCode || "");
            } else {
                prizeText = "-";
            }

            var now = new Date().getTime();
            var endPretty = formatDateTime(d.endDate);
            var soonLabel = "";
            if (d.endDate) {
                var tEnd = new Date(d.endDate).getTime();
                if (!isNaN(tEnd) && tEnd > now && (tEnd - now) <= (24 * 60 * 60 * 1000)) {
                    soonLabel = "<span class='badge-ending-soon ms-2'>Ending soon</span>";
                }
            }

            var joinHtml;
            if (isJoined) {
                joinHtml = "<span class='badge-joined me-2'>Joined</span>";
            } else {
                joinHtml = "<button class='btn btn-dark btn-sm me-2' onclick='joinDraw(" + d.id + ")'>Join Now</button>";
            }

            joinHtml += "<button class='btn btn-outline-secondary btn-sm' onclick='openDrawDetails(" + d.id + ")'>Details</button>";

            var accessText = "Standard";
            if (d.voucherCode && d.voucherCode !== "") {
                accessText = "Voucher: " + d.voucherCode;
            }

            var card = document.createElement("div");
            card.className = "draw-card";

            card.innerHTML =
                "<div class='d-flex justify-content-between align-items-start'>" +
                "  <div>" +
                "    <h5 class='mb-1'>" + escapeHtml(d.name || "Draw") + "</h5>" +
                "    <div class='draw-meta mb-1'>Prize: <strong>" + escapeHtml(prizeText) + "</strong></div>" +
                "    <div class='draw-meta mb-1'>Starts: " + formatDateTime(d.startDate) + "</div>" +
                "    <div class='draw-meta'>Ends: " + endPretty + "</div>" +
                "  </div>" +
                "  <div class='text-end'>" +
                "    <div class='mb-2'><span class='draw-pill'>" + escapeHtml(accessText) + "</span> " + soonLabel + "</div>" +
                     joinHtml +
                "  </div>" +
                "</div>";

            container.appendChild(card);
        }

        if (visible === 0) {
            container.innerHTML = "<div class='empty-box'>No draws match your filters.</div>";
        }
    }

    // JOIN FLOW WITH VOUCHER LOGIC (A: ask only if SPECIFIC)
    function joinDraw(drawId) {
        if (!userId) {
            showToast("Please login or join as guest first", false);
            redirectTo("/user/login.html");
            return;
        }

        // Find draw
        var d = null;
        var i;
        for (i = 0; i < allActiveDraws.length; i++) {
            if (allActiveDraws[i].id === drawId) {
                d = allActiveDraws[i];
                break;
            }
        }
        if (!d) {
            showToast("Draw not found in list", false);
            return;
        }

        // If draw has no voucher, join directly
        if (!d.voucherCode || d.voucherCode === "") {
            doJoin(drawId, null);
            return;
        }

        // Draw has voucherCode: check voucher details using validate
        apiFetch("/vouchers/validate", "POST", { code: d.voucherCode })
            .then(function (json) {
                if (!json || !json.success || !json.data) {
                    // cannot validate, fallback: ask voucher
                    openVoucherModal(drawId, d.voucherCode);
                    return;
                }

                var v = json.data;
                var accessLevel = v.accessLevel || "ALL";

                if (accessLevel === "SPECIFIC") {
                    // Ask user to enter matching voucher
                    openVoucherModal(drawId, d.voucherCode);
                } else {
                    // ALL / GUEST -> join directly, using userVoucher if we have
                    var vc = userVoucher && userVoucher !== "" ? userVoucher : d.voucherCode;
                    doJoin(drawId, vc);
                }
            }).catch(function () {
                // on error, fallback to modal
                openVoucherModal(drawId, d.voucherCode);
            });
    }

    function openVoucherModal(drawId, expectedCode) {
        document.getElementById("joinVoucherInput").value = "";
        document.getElementById("joinDrawIdHidden").value = String(drawId);
        document.getElementById("joinExpectedVoucherHidden").value = expectedCode || "";
        var modalEl = document.getElementById("joinVoucherModal");
        var modal = new bootstrap.Modal(modalEl);
        modal.show();
    }

    function confirmJoinWithVoucher() {
        var code = document.getElementById("joinVoucherInput").value.trim();
        var drawId = Number(document.getElementById("joinDrawIdHidden").value);
        var expected = document.getElementById("joinExpectedVoucherHidden").value;

        if (code === "") {
            showToast("Please enter voucher code", false);
            return;
        }

        // Validate entered code first
        apiFetch("/vouchers/validate", "POST", { code: code })
            .then(function (json) {
                if (!json || !json.success) {
                    showToast("Invalid voucher code", false);
                    return;
                }

                // If draw expects a specific code, enforce it
                if (expected && expected !== "" && code !== expected) {
                    showToast("This draw requires a specific voucher code.", false);
                    return;
                }

                doJoin(drawId, code);

                // Close modal
                var modalEl = document.getElementById("joinVoucherModal");
                var modal = bootstrap.Modal.getInstance(modalEl);
                if (modal) modal.hide();
            });
    }

    function doJoin(drawId, voucherCode) {
        var body = {
            userId: Number(userId),
            voucherCode: voucherCode,
            accountDetailsJson: "{}"
        };

        apiFetch("/draws/" + drawId + "/join", "POST", body)
            .then(function (json) {
                if (!json) {
                    showToast("Failed to join draw", false);
                    return;
                }

                if (!json.success) {
                    if (json.message) showToast(json.message, false);
                    else showToast("Failed to join draw", false);
                    return;
                }

                showToast("Joined draw successfully!", true);

                joinedDrawIds[drawId] = true;

                // update stats & cards
                document.getElementById("statJoined").innerText = Object.keys(joinedDrawIds).length;
                renderDrawCards();
            })
            .catch(function () {
                showToast("Failed to join draw", false);
            });
    }

    function openDrawDetails(drawId) {
        apiFetch("/draws/" + drawId, "GET")
            .then(function (json) {
                if (!json || !json.success || !json.data) {
                    showToast("Failed to load draw details", false);
                    return;
                }
                var d = json.data;
                document.getElementById("detailModalTitle").innerText = d.name || "Draw Details";

                var prizeType = d.prizeType || "-";
                var prizeAmount = d.prizeAmount || "-";
                var voucher = d.voucherCode || "-";
                var maxWinners = (d.maxWinners !== null && d.maxWinners !== undefined) ? d.maxWinners : "-";
                var description = d.description || "-";
                var department = d.department || "-";
                var startStr = formatDateTime(d.startDate);
                var endStr = formatDateTime(d.endDate);

                var html =
                    "<div class='row mb-2'>" +
                    "  <div class='col-md-6'><b>Prize Type:</b> " + escapeHtml(prizeType) + "</div>" +
                    "  <div class='col-md-6'><b>Prize Amount:</b> " + escapeHtml(prizeAmount) + "</div>" +
                    "</div>" +
                    "<div class='row mb-2'>" +
                    "  <div class='col-md-6'><b>Voucher:</b> " + escapeHtml(voucher) + "</div>" +
                    "  <div class='col-md-6'><b>Max Winners:</b> " + escapeHtml(maxWinners) + "</div>" +
                    "</div>" +
                    "<div class='row mb-2'>" +
                    "  <div class='col-md-6'><b>Department:</b> " + escapeHtml(department) + "</div>" +
                    "  <div class='col-md-6'><b>Timer Seconds:</b> " + (d.timerSeconds || "-") + "</div>" +
                    "</div>" +
                    "<div class='mb-2'><b>Description:</b><br>" + escapeHtml(description) + "</div>" +
                    "<div class='row mt-2'>" +
                    "  <div class='col-md-6'><b>Start:</b> " + startStr + "</div>" +
                    "  <div class='col-md-6'><b>End:</b> " + endStr + "</div>" +
                    "</div>";

                document.getElementById("detailModalBody").innerHTML = html;

                var modal = new bootstrap.Modal(document.getElementById("drawDetailModal"));
                modal.show();
            });
    }

    function formatDateTime(iso) {
        if (!iso) return "-";
        var d = new Date(iso);
        if (isNaN(d.getTime())) return iso;

        var day = d.getDate();
        if (day < 10) day = "0" + day;

        var monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
        var month = monthNames[d.getMonth()];
        var year = d.getFullYear();

        var hours = d.getHours();
        var minutes = d.getMinutes();
        var ampm = hours >= 12 ? "PM" : "AM";
        hours = hours % 12;
        if (hours === 0) hours = 12;
        if (minutes < 10) minutes = "0" + minutes;

        return day + " " + month + " " + year + ", " + hours + ":" + minutes + " " + ampm;
    }

    function escapeHtml(s) {
        if (s === undefined || s === null) return "";
        return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
    }

    function logoutUser() {
        try {
            localStorage.removeItem("userId");
            localStorage.removeItem("userName");
            localStorage.removeItem("userVoucher");
        } catch (e) {}
        redirectTo("/user/login.html");
    }

    function redirectTo(url) {
        window.location.href = url;
    }
</script>

</body>
</html>
