<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Available Draws</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/css/style.css">

    <style>
        body {
            background: #f1f5f9;
        }

        /* Sidebar (same as dashboard) */
        .sidebar {
            width: 240px;
            background: white;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            padding: 20px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, .08);
        }

        .sidebar-item {
            padding: 12px 16px;
            margin-bottom: 6px;
            border-radius: 14px;
            cursor: pointer;
        }

        .sidebar-item:hover {
            background: #f3f4f6;
        }

        .sidebar-active {
            background: #e6f0ff;
        }

        .content {
            margin-left: 260px;
            padding: 30px;
        }

        /* Draw Cards */
        .draw-card {
            background: white;
            padding: 20px;
            border-radius: 18px;
            box-shadow: 0 5px 18px rgba(0, 0, 0, .08);
            transition: .2s;
            cursor: pointer;
        }

        .draw-card:hover {
            transform: translateY(-3px);
        }

        .draw-ended {
            opacity: 0.5;
            background: #f8fafc;
        }

        .draw-won {
            border-left: 6px solid #16a34a;
            background: #ecfdf5;
            box-shadow: 0 4px 18px rgba(16, 185, 129, 0.3);
        }

        .badge-cash {
            background: #e0e7ff;
            color: #3730a3;
        }

        .badge-voucher {
            background: #fce7f3;
            color: #be185d;
        }

        /* Modal */
        .modal-card {
            background: white;
            padding: 25px;
            border-radius: 20px;
        }
    </style>
</head>

<body>

    <!-- Sidebar -->
    <div class="sidebar">
        <h4 class="mb-4">User Panel</h4>

        <div class="sidebar-item" onclick="redirectTo('/user/dashboard.html')">Dashboard</div>
        <div class="sidebar-item sidebar-active">Available Draws</div>
        <div class="sidebar-item" onclick="redirectTo('/user/joined.html')">Joined Draws</div>
        <div class="sidebar-item" onclick="redirectTo('/user/winners.html')">Winners</div>
        <div class="sidebar-item" onclick="redirectTo('/user/history.html')">History</div>
        <div class="sidebar-item" onclick="redirectTo('/user/profile.html')">Profile</div>
        <div class="sidebar-item" onclick="logoutUser()">Logout</div>
    </div>

    <!-- Content -->
    <div class="content">

        <h2 class="mb-4">Available Draws</h2>

        <!-- Filters -->
        <div class="card-apple mb-4 p-3">
            <div class="row g-3">

                <div class="col-md-3">
                    <select id="filterType" class="form-control" onchange="applyFilters()">
                        <option value="">All Types</option>
                        <option value="CASH">Cash Prize</option>
                        <option value="VOUCHER">Voucher Prize</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <select id="filterSort" class="form-control" onchange="applyFilters()">
                        <option value="recent">Most Recent</option>
                        <option value="old">Oldest First</option>
                    </select>
                </div>

                <div class="col-md-3 text-end">
                    <button class="btn btn-dark" onclick="exportCsv()">CSV</button>
                </div>

                <div class="col-md-3 text-end">
                    <button class="btn btn-danger" onclick="exportPdf()">PDF</button>
                </div>

            </div>
        </div>

        <!-- Draws List -->
        <div id="drawBox" class="row g-3"></div>

        <!-- Load More -->
        <div class="text-center mt-4">
            <button class="btn btn-outline-primary" onclick="loadMore()">Load More</button>
        </div>

    </div>

    <!-- Join Modal -->
    <div class="modal fade" id="joinModal">
        <div class="modal-dialog">
            <div class="modal-card">
                <h4 id="joinDrawTitle">Join Draw</h4>

                <div class="mb-3">
                    <label>Voucher Code (if required)</label>
                    <input id="joinVoucher" class="form-control" placeholder="Enter voucher code">
                </div>

                <button class="btn btn-success w-100" onclick="confirmJoin()">Join Now</button>
            </div>
        </div>
    </div>

    <script src="/assets/js/common.js"></script>

    <script>
        var userId = localStorage.getItem("userId");
        var currentPage = 0;
        var allDraws = [];

        if (!userId) redirectTo("/user/login.html");

        window.onload = function () {
            loadDraws();
        };

        function loadDraws() {
            apiFetch("/draws/active?page=" + currentPage + "&size=6", "GET")
                .then(function (json) {

                    if (!json || !json.success) return;

                    var list = json.data.content;

                    for (var i = 0; i < list.length; i++) {
                        allDraws.push(list[i]);
                    }

                    renderDraws(allDraws);
                });
        }

        function renderDraws(list) {
            var box = document.getElementById("drawBox");
            box.innerHTML = "";

            for (var i = 0; i < list.length; i++) {
                var d = list[i];

                var badge =
                    d.prizeType === "CASH"
                        ? "<span class='badge badge-cash'>Cash</span>"
                        : "<span class='badge badge-voucher'>Voucher</span>";

                var endedClass = d.status === "ENDED" ? "draw-ended" : "";
                var winClass = d.userWon ? "draw-won" : "";

                var card =
                    "<div class='col-md-4'>" +
                    "  <div class='draw-card " + endedClass + " " + winClass + "'>" +
                    "    <h5>" + d.name + "</h5>" +
                    "    " + badge + "<br>" +
                    "    <small>Ends: " + d.endDate + "</small><br><br>" +
                    "    <button class='btn btn-primary btn-sm' onclick=\"openJoinModal(" + d.id + ", '" + d.name + "')\">Join</button>" +
                    "  </div>" +
                    "</div>";

                box.innerHTML += card;
            }
        }

        function applyFilters() {
            var type = document.getElementById("filterType").value;
            var sort = document.getElementById("filterSort").value;

            var filtered = [];

            for (var i = 0; i < allDraws.length; i++) {
                var d = allDraws[i];

                if (type !== "" && d.prizeType !== type) continue;

                filtered.push(d);
            }

            if (sort === "recent") {
                filtered.sort(function (a, b) { return new Date(b.startDate) - new Date(a.startDate); });
            } else {
                filtered.sort(function (a, b) { return new Date(a.startDate) - new Date(b.startDate); });
            }

            renderDraws(filtered);
        }

        function loadMore() {
            currentPage++;
            loadDraws();
        }

        var joinDrawId = null;

        function openJoinModal(id, name) {
            joinDrawId = id;
            document.getElementById("joinDrawTitle").innerText = name;
            document.getElementById("joinVoucher").value = "";
            new bootstrap.Modal(document.getElementById("joinModal")).show();
        }

        function confirmJoin() {
            var voucher = document.getElementById("joinVoucher").value;

            var body = {
                userId: userId,
                voucherCode: voucher,
                accountDetailsJson: "{}"
            };

            apiFetch("/draws/" + joinDrawId + "/join", "POST", body)
                .then(function (json) {

                    if (!json || !json.success) {
                        showToast("Unable to join draw", false);
                        return;
                    }

                    showToast("Joined successfully!", true);
                    setTimeout(function () { location.reload(); }, 800);
                });
        }

        function exportCsv() {
            redirectTo("/users/" + userId + "/draws/history/export?format=csv");
        }

        function exportPdf() {
            redirectTo("/users/" + userId + "/draws/history/export?format=pdf");
        }

        function redirectTo(url) {
            window.location.href = url;
        }

        function logoutUser() {
            localStorage.removeItem("userId");
            redirectTo("/user/login.html");
        }

    </script>

</body>

</html>
