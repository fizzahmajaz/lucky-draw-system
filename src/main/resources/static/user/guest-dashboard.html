<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Guest Dashboard</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="/assets/css/style.css">

  <style>
    body { background:#f6f7fb; }
    .card-apple{
      background:white; padding:20px; border-radius:18px;
      box-shadow:0 6px 20px rgba(0,0,0,0.05);
      margin-bottom:16px;
    }
    .section-title{ font-weight:600; margin-top:18px; margin-bottom:10px;}
    .empty-box{
      background:#f9fafb; border-radius:14px; padding:16px;
      text-align:center; color:#6b7280;
    }
  </style>
</head>
<body>

<div class="toast-box" id="toast-box"></div>

<div class="container py-4" style="max-width:820px;">

  <!-- Header / Welcome -->
  <div class="card-apple d-flex justify-content-between align-items-center">
    <div>
      <h3 id="guestNameText" class="mb-1">Welcome Guest</h3>
      <div class="text-muted">Guest mode â€¢ Public draws only</div>
    </div>
    <div class="text-end">
      <button class="btn btn-outline-secondary me-2" onclick="window.location.href='/user/guest.html'">
        Switch Guest
      </button>
      <button class="btn btn-outline-primary me-2" onclick="window.location.href='/user/guest-winners.html'">
        View Winners
      </button>
      <button class="btn btn-outline-success" id="autoRefreshBtn" onclick="toggleAutoRefresh()">
        Auto Refresh: OFF
      </button>
    </div>
  </div>

  <!-- Available Draws -->
  <div class="section-title">Available Public Draws</div>
  <div id="drawList"></div>

  <!-- Joined Draws -->
  <div class="section-title">Your Joined Draws</div>
  <div id="joinedList"></div>

</div>

<script src="/assets/js/common.js"></script>

<script>
var uid = null;
var uname = null;

var autoRefresh = false;
var autoRefreshInterval = null;

window.onload = function(){
  uid = localStorage.getItem("userId");
  uname = localStorage.getItem("username");

  if(!uid){
    showToast("Please register as guest first", false);
    setTimeout(function(){ window.location.href="/user/guest.html"; },800);
    return;
  }

  document.getElementById("guestNameText").innerHTML = "Welcome " + (uname || "Guest");

  loadDraws();
  loadJoined();
};

// ------------------- Draws -------------------
async function loadDraws(){
  var box = document.getElementById("drawList");
  box.innerHTML = "<div class='empty-box'>Loading draws...</div>";

  var json = await apiFetch("/draws/active?page=0&size=100", "GET");

  if(!json || !json.success){
    box.innerHTML = "<div class='empty-box'>Unable to load draws.</div>";
    return;
  }

  var list = json.data && json.data.content ? json.data.content : [];
  box.innerHTML = "";

  var shown = 0;

  for(var i=0; i<list.length; i++){
    var d = list[i];

    var access = d.accessLevel || "ALL";
    var voucher = d.voucherCode || "";

    // Guest sees only ALL-access draws
    if(access !== "ALL" && voucher !== ""){
      continue;
    }

    shown++;

    var card = document.createElement("div");
    card.className = "card-apple";

    card.innerHTML =
      "<h5 class='mb-1'>" + (d.name || "-") + "</h5>" +
      "<div class='text-muted small mb-2'>Prize: " + (d.prizeType || "-") +
      " â€¢ Ends: " + (d.endDate || "-") + "</div>" +
      "<button class='btn btn-dark' onclick='joinDraw(" + d.id + ")'>Join</button>";

    box.appendChild(card);
  }

  if(shown === 0){
    box.innerHTML = "<div class='empty-box'>No public draws available right now.</div>";
  }
}

async function joinDraw(drawId){
  var body = {
    userId: Number(uid),
    voucherCode: null,
    accountDetailsJson: "{}"
  };

  var json = await apiFetch("/draws/" + drawId + "/join", "POST", body);

  if(!json || !json.success){
    showToast(json && json.message ? json.message : "Join failed", false);
    return;
  }

  showToast("Joined successfully!", true);
  loadJoined();
}

// ------------------- Joined -------------------
async function loadJoined(){
  var box = document.getElementById("joinedList");
  box.innerHTML = "<div class='empty-box'>Loading joined draws...</div>";

  var json = await apiFetch("/users/" + uid + "/draws/joined", "GET");
  if(!json || !json.success){
    box.innerHTML = "<div class='empty-box'>Unable to load joined draws.</div>";
    return;
  }

  var list = json.data || [];
  box.innerHTML = "";

  if(!list || list.length === 0){
    box.innerHTML = "<div class='empty-box'>You have not joined any draws yet.</div>";
    return;
  }

  // Show latest 3
  var limit = list.length < 3 ? list.length : 3;

  for(var i=0; i<limit; i++){
    var d = list[i];
    var status = d.status || "WAITING";
    var label = status;

    if(status === "WINNER") label = "Winner";
    else if(status === "LOST") label = "Lost";
    else if(status === "RUNNING") label = "Running";
    else if(status === "ENDED") label = "Ended";
    else label = "Waiting";

    var card = document.createElement("div");
    card.className = "card-apple";

    card.innerHTML =
      "<div class='d-flex justify-content-between'>" +
        "<div>" +
          "<strong>" + (d.drawName || "-") + "</strong>" +
          "<div class='small text-muted'>Joined: " + (d.joinedAt || "-") + "</div>" +
        "</div>" +
        "<div class='small'>" + label + "</div>" +
      "</div>";

    box.appendChild(card);
  }
}

// ------------------- Auto Refresh -------------------
function toggleAutoRefresh(){
  autoRefresh = !autoRefresh;
  var btn = document.getElementById("autoRefreshBtn");

  if(autoRefresh){
    btn.innerHTML = "Auto Refresh: ON ðŸ”µ";
    btn.classList.remove("btn-outline-success");
    btn.classList.add("btn-success");

    loadDraws();
    loadJoined();

    autoRefreshInterval = setInterval(function(){
      loadDraws();
      loadJoined();
    }, 15000);

    showToast("Auto Refresh enabled", true);
  } else {
    btn.innerHTML = "Auto Refresh: OFF";
    btn.classList.remove("btn-success");
    btn.classList.add("btn-outline-success");

    if(autoRefreshInterval){
      clearInterval(autoRefreshInterval);
      autoRefreshInterval = null;
    }

    showToast("Auto Refresh disabled", true);
  }
}
</script>

</body>
</html>
